<!doctype html>
<html>

	<head>

		<link type="text/css" rel="stylesheet" href="treez-file-path.css" />

        <script>

            class TreezFilePath extends HTMLElement {

            	static get observedAttributes() {
                    return ['title','value'];
                }



                constructor(){
                    super();                  
                    this.label=undefined;   
                    this.textField=undefined;
                    this.fileInput=undefined;  
                    this.listeners = [];              
                }            	

                connectedCallback() {
                	var self = this;

                    if(!self.label){                       

                        var label = document.createElement('label');  
                        self.label = label;                     
                        label.innerText = self.title;                       
                        self.appendChild(label);  

                        var container = document.createElement('div');
                        container.id ='container';                       
                        self.appendChild(container);  

                        var leftSpan = document.createElement('span');
                        container.appendChild(leftSpan);                    

                        var textField = document.createElement('input');
                        self.textField = textField;   
                        textField.value = self.value;                    
                        textField.type='text'  
                        textField.onchange = ()=>this.textFieldChanged();                                              
                        leftSpan.appendChild(textField);

                        var rightSpan = document.createElement('span');
                        container.appendChild(rightSpan); 

					    var fileInput = document.createElement('input');
					    self.fileInput = fileInput;						   
					    fileInput.type='file';
					    fileInput.title=' ';
					    fileInput.onchange = ()=>this.fileInputChanged();				   
                        rightSpan.appendChild(fileInput);                       		
                    }
                }

                textFieldChanged(){
                	this.value = this.textField.value;
                	this.fileInput.value = '';
                	for(var listener in this.listeners){
				  	   listener(newValue);
				    }
                }

                fileInputChanged(){
                	var file = this.fileInput.files[0]
                	if(file){
                		this.value = file.name;
                	    this.textField.value = this.value;
                	}
                }

                disconnectedCallback(){
                	while (this.firstChild) {
						this.removeChild(this.firstChild);
					}
                }

                attributeChangedCallback(attr, oldValue, newValue) {
                    if(attr==='title'){
                    	if(this.label){
                    		 this.label.innerText= newValue;   
                    	}                                           
                    } else if(attr==='value'){
                    	


                    	if(this.textField){                    		
							if(newValue!=oldValue){
								this.textField.value= newValue;   
								if(this.fileInput){
									this.fileInput.value= '';   
								} 
								var event = new Event('input', {
									'bubbles': true,
									'cancelable': true
								});
								this.dispatchEvent(event);

							}                    		
                    	}  
                    }
                }

                get value() {
				  return this.getAttribute('value');
				}

				set value(newValue) {
				  this.setAttribute('value', newValue);	  

				}

				bindValue(parent, lambdaExpression){

                    var self = this;
					
					var propertyName = lambdaExpression.toString().split(".")[1];
					self.value = parent[propertyName];					

                    //update property on element changes
					self.listeners.push((newValue)=>{ 
						  var oldValue = parent[propertyName];					
						  if(newValue != oldValue){
							parent[propertyName] = newValue;        
						  } 
					});  

                    //upddate element on property changes
					var property = Object.getOwnPropertyDescriptor(parent, propertyName);

					var privateValue = parent[propertyName];

					Object.defineProperty(parent, propertyName, {
						get: function(){
							if(property.get){
                                return property.get();
							} else {
								return privateValue;
							}
						},
						set: function(newValue){
							var oldValue = privateValue;
							if(newValue != oldValue){
						         
						         if(property.set){
						         	property.set(newValue);
						         } 
						         privateValue = newValue; 
						         self.value = newValue;						         
							}     
					    }						
					});  



					

				}

               
            }
            window.customElements.define('treez-file-path', TreezFilePath); 

                   

        </script>	
		
	</head>

</html>