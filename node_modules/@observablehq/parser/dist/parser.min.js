// @observablehq/parser v4.2.0 Copyright 2020 Observable, Inc.
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("acorn"),require("acorn-walk")):"function"==typeof define&&define.amd?define(["exports","acorn","acorn-walk"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).observablehq=e.observablehq||{},e.acorn,e.acorn.walk)}(this,(function(e,t,r){"use strict";var n=new Set(["Array","ArrayBuffer","atob","AudioContext","Blob","Boolean","BigInt","btoa","clearInterval","clearTimeout","console","crypto","CustomEvent","DataView","Date","decodeURI","decodeURIComponent","devicePixelRatio","document","encodeURI","encodeURIComponent","Error","escape","eval","fetch","File","FileList","FileReader","Float32Array","Float64Array","Function","Headers","Image","ImageData","Infinity","Int16Array","Int32Array","Int8Array","Intl","isFinite","isNaN","JSON","Map","Math","NaN","Number","navigator","Object","parseFloat","parseInt","performance","Path2D","Promise","Proxy","RangeError","ReferenceError","Reflect","RegExp","cancelAnimationFrame","requestAnimationFrame","Set","setInterval","setTimeout","String","Symbol","SyntaxError","TextDecoder","TextEncoder","this","TypeError","Uint16Array","Uint32Array","Uint8Array","Uint8ClampedArray","undefined","unescape","URIError","URL","WeakMap","WeakSet","WebSocket","Worker","window"]),s=r.make({Import(){},ViewExpression(e,t,r){r(e.id,t,"Identifier")},MutableExpression(e,t,r){r(e.id,t,"Identifier")}});function a(e){return"FunctionExpression"===e.type||"FunctionDeclaration"===e.type||"ArrowFunctionExpression"===e.type||"Program"===e.type}function o(e){return"BlockStatement"===e.type||"ForInStatement"===e.type||"ForOfStatement"===e.type||"ForStatement"===e.type||a(e)}function i(e){return"FunctionExpression"===e.type||"FunctionDeclaration"===e.type}function c(e,t){const n={type:"Program",body:[e.body]},a=new Map,{references:o}=e;return r.simple(n,{CallExpression:e=>{const{callee:r,arguments:n}=e;if("Identifier"!==r.type||r.name!==t||o.indexOf(r)<0)return;if(1!==n.length||!("Literal"===n[0].type&&/^['"]/.test(n[0].raw)||"TemplateLiteral"===n[0].type&&0===n[0].expressions.length))throw Object.assign(new SyntaxError(t+" requires a single literal string argument"),{node:e});const[s]=n,i="Literal"===s.type?s.value:s.quasis[0].value.cooked,c={start:s.start,end:s.end};a.has(i)?a.get(i).push(c):a.set(i,[c])}},s),a}const p=Symbol("start"),l=Symbol("modifier"),u=Symbol("function"),f=Symbol("name");class h extends t.Parser{constructor(e,...t){super(Object.assign({ecmaVersion:12},e),...t)}enterScope(e){return 2&e&&++this.O_function,super.enterScope(e)}exitScope(){return 2&this.currentScope().flags&&--this.O_function,super.exitScope()}parseForIn(e,t){return 1===this.O_function&&e.await&&(this.O_async=!0),super.parseForIn(e,t)}parseAwait(){return 1===this.O_function&&(this.O_async=!0),super.parseAwait()}parseYield(e){return 1===this.O_function&&(this.O_generator=!0),super.parseYield(e)}parseImport(e){return this.next(),e.specifiers=this.parseImportSpecifiers(),this.type===t.tokTypes._with&&(this.next(),e.injections=this.parseImportSpecifiers()),this.expectContextual("from"),e.source=this.type===t.tokTypes.string?this.parseExprAtom():this.unexpected(),this.finishNode(e,"ImportDeclaration")}parseImportSpecifiers(){const e=[],r=new Set;let n=!0;for(this.expect(t.tokTypes.braceL);!this.eat(t.tokTypes.braceR);){if(n)n=!1;else if(this.expect(t.tokTypes.comma),this.afterTrailingComma(t.tokTypes.braceR))break;const s=this.startNode();s.view=this.eatContextual("viewof"),s.mutable=!s.view&&this.eatContextual("mutable"),s.imported=this.parseIdent(),this.checkUnreserved(s.imported),this.checkLocal(s.imported),this.eatContextual("as")?(s.local=this.parseIdent(),this.checkUnreserved(s.local),this.checkLocal(s.local)):s.local=s.imported,this.checkLVal(s.local,"let"),r.has(s.local.name)&&this.raise(s.local.start,`Identifier '${s.local.name}' has already been declared`),r.add(s.local.name),e.push(this.finishNode(s,"ImportSpecifier"))}return e}parseExprAtom(e){return this.parseMaybeKeywordExpression("viewof","ViewExpression")||this.parseMaybeKeywordExpression("mutable","MutableExpression")||super.parseExprAtom(e)}parseCell(e,r){const n=new h({},this.input,this.start);let s=n.getToken(),a=null,o=null;return this.O_function=0,this.O_async=!1,this.O_generator=!1,this.strict=!0,this.enterScope(14),s.type===t.tokTypes._import&&n.getToken().type!==t.tokTypes.parenL?a=this.parseImport(this.startNode()):s.type!==t.tokTypes.eof&&s.type!==t.tokTypes.semi&&(s.type===t.tokTypes.name&&("viewof"!==s.value&&"mutable"!==s.value||(s=n.getToken(),s.type!==t.tokTypes.name&&n.unexpected()),s=n.getToken(),s.type===t.tokTypes.eq&&(o=this.parseMaybeKeywordExpression("viewof","ViewExpression")||this.parseMaybeKeywordExpression("mutable","MutableExpression")||this.parseIdent(),s=n.getToken(),this.expect(t.tokTypes.eq))),s.type===t.tokTypes.braceL?a=this.parseBlock():(a=this.parseExpression(),null!==o||"FunctionExpression"!==a.type&&"ClassExpression"!==a.type||(o=a.id))),this.semicolon(),r&&this.expect(t.tokTypes.eof),o&&this.checkLocal(o),e.id=o,e.async=this.O_async,e.generator=this.O_generator,e.body=a,this.exitScope(),this.finishNode(e,"Cell")}parseTopLevel(e){return this.parseCell(e,!0)}toAssignable(e,t,r){return"MutableExpression"===e.type?e:super.toAssignable(e,t,r)}checkLocal(e){const t=e.id||e;(n.has(t.name)||"arguments"===t.name)&&this.raise(t.start,`Identifier '${t.name}' is reserved`)}checkUnreserved(e){return"viewof"!==e.name&&"mutable"!==e.name||this.raise(e.start,`Unexpected keyword '${e.name}'`),super.checkUnreserved(e)}checkLVal(e,t,r){return super.checkLVal("MutableExpression"===e.type?e.id:e,t,r)}unexpected(e){this.raise(null!=e?e:this.start,this.type===t.tokTypes.eof?"Unexpected end of input":"Unexpected token")}parseMaybeKeywordExpression(e,t){if(this.isContextual(e)){const e=this.startNode();return this.next(),e.id=this.parseIdent(),this.finishNode(e,t)}}}class d extends h{parseTopLevel(e){for(e.cells||(e.cells=[]);this.type!==t.tokTypes.eof;){const t=this.parseCell(this.startNode());t.input=this.input,e.cells.push(t)}return this.next(),this.finishNode(e,"Program")}}function y(e,c,p=n){if(e.body&&"ImportDeclaration"!==e.body.type)try{e.references=function(e,t){const n={type:"Program",body:[e.body]},c=new Map,p=new Set(t),l=[];function u(e,t){const r=c.get(e);return!!r&&r.has(t)}function f(e,t){const r=c.get(e);r?r.add(t.name):c.set(e,new Set([t.name]))}function h(e){e.params.forEach(t=>d(t,e)),e.id&&f(e,e.id)}function d(e,t){switch(e.type){case"Identifier":f(t,e);break;case"ObjectPattern":e.properties.forEach(e=>d(e,t));break;case"ArrayPattern":e.elements.forEach(e=>e&&d(e,t));break;case"Property":d(e.value,t);break;case"RestElement":d(e.argument,t);break;case"AssignmentPattern":d(e.left,t);break;default:throw new Error("Unrecognized pattern type: "+e.type)}}function y(e){f(n,e.local)}function m(e,t){let r=e.name;if("undefined"!==r){for(let n=t.length-2;n>=0;--n){if("arguments"===r&&i(t[n]))return;if(u(t[n],r))return;"ViewExpression"===t[n].type&&(r="viewof "+(e=t[n]).id.name),"MutableExpression"===t[n].type&&(r="mutable "+(e=t[n]).id.name)}if(!p.has(r)){if("arguments"===r)throw Object.assign(new SyntaxError("arguments is not allowed"),{node:e});l.push(e)}}}function b(e,t){switch(e.type){case"Identifier":case"VariablePattern":n(e,t);break;case"ArrayPattern":case"ObjectPattern":r.ancestor(e,{Identifier:n,VariablePattern:n},s)}function n(e,r){for(const r of t)if(u(r,e.name))return;if("MutableExpression"!==r[r.length-2].type)throw Object.assign(new SyntaxError("Assignment to constant variable "+e.name),{node:e})}}function x(e,t){b(e.left,t)}return r.ancestor(n,{VariableDeclaration:(e,t)=>{let r=null;for(let n=t.length-1;n>=0&&null===r;--n)("var"===e.kind?a(t[n]):o(t[n]))&&(r=t[n]);e.declarations.forEach(e=>d(e.id,r))},FunctionDeclaration:(e,t)=>{let r=null;for(let e=t.length-2;e>=0&&null===r;--e)a(t[e])&&(r=t[e]);f(r,e.id),h(e)},Function:h,ClassDeclaration:(e,t)=>{let r=null;for(let e=t.length-2;e>=0&&null===r;e--)a(t[e])&&(r=t[e]);f(r,e.id)},Class:function(e){e.id&&f(e,e.id)},CatchClause:function(e){e.param&&d(e.param,e)},ImportDefaultSpecifier:y,ImportSpecifier:y,ImportNamespaceSpecifier:y},s),r.ancestor(n,{VariablePattern:m,Identifier:m},s),r.ancestor(n,{AssignmentExpression:x,UpdateExpression:function(e,t){b(e.argument,t)},ForOfStatement:x,ForInStatement:x},s),l}(e,p)}catch(e){if(e.node){const r=t.getLineInfo(c,e.node.start);e.message+=` (${r.line}:${r.column})`,e.pos=e.node.start,e.loc=r,delete e.node}throw e}return e}function m(e,r){if(e.body&&"ImportDeclaration"!==e.body.type)try{e.fileAttachments=c(e,"FileAttachment"),e.databaseClients=c(e,"DatabaseClient"),e.secrets=c(e,"Secret")}catch(e){if(e.node){const n=t.getLineInfo(r,e.node.start);e.message+=` (${n.line}:${n.column})`,e.pos=e.node.start,e.loc=n,delete e.node}throw e}else e.fileAttachments=new Map,e.databaseClients=new Map,e.secrets=new Map;return e}e.CellParser=h,e.ModuleParser=d,e.parseCell=function(e,{globals:t}={}){const r=h.parse(e);return y(r,e,t),m(r),r},e.parseModule=function(e,{globals:t}={}){const r=d.parse(e);for(const n of r.cells)y(n,e,t),m(n,e);return r},e.peekId=function(e){let r,n=p;try{for(const s of t.Parser.tokenizer(e,{ecmaVersion:11})){switch(n){case p:case l:if(s.type===t.tokTypes.name){if(n===p&&("viewof"===s.value||"mutable"===s.value||"async"===s.value)){n=l;continue}n=f,r=s;continue}if(s.type===t.tokTypes._function||s.type===t.tokTypes._class){n=u;continue}break;case f:if(s.type===t.tokTypes.eq)return r.value;break;case u:if(s.type===t.tokTypes.star)continue;if(s.type===t.tokTypes.name&&s.end<e.length)return s.value}return}}catch(e){return}},e.walk=s,Object.defineProperty(e,"__esModule",{value:!0})}));
